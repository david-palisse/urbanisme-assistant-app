
*Définition technique de l'arbre de décision suivant le modèle de [[Arborescence générale des questions]]*
### Bloc 0 & 1 – Accueil, projet, localisation

| Step ID            | Parent             | Condition d’entrée     | Message bot (simplifié)                                                                  | Input attendu                                           | Données capturées                                      | Action système                      | Step suivant              |
| ------------------ | ------------------ | ---------------------- | ---------------------------------------------------------------------------------------- | ------------------------------------------------------- | ------------------------------------------------------ | ----------------------------------- | ------------------------- |
| S0_WELCOME         | —                  | Début de session       | Bonjour… Quel type de projet ?                                                           | Choix bouton + texte libre                              | `type_projet_brut`                                     | —                                   | S1_TYPE_REFINEMENT        |
| S1_TYPE_REFINEMENT | S0_WELCOME         | Toujours               | Merci. Précisez les caractéristiques principales (surface, hauteur, nature des travaux). | Texte + éventuellement boutons (ex : enterree/hors-sol) | `surface_creee`, `hauteur`, `nature_travaux`           | Normalisation type projet           | S2_ADDRESS                |
| S2_ADDRESS         | S1_TYPE_REFINEMENT | Toujours               | À quelle adresse se situe le projet ?                                                    | Adresse (texte) ou recherche carte                      | `adresse_brute`                                        | Géocodage (API)                     | S3_ADDRESS_CONFIRM        |
| S3_ADDRESS_CONFIRM | S2_ADDRESS         | Géocodage OK           | J’ai trouvé : [adresse normalisée]. Est-ce bien ici ?                                    | Boutons Oui / Non                                       | `adresse_normalisee`, `coordonnees`, `parcelle` si Oui | Si Non, relancer S2 / S2_MAP        | Si Oui → S4_CONTEXT_FETCH |
| S4_CONTEXT_FETCH   | S3_ADDRESS_CONFIRM | Adresse confirmée      | (Message court) Je récupère les règles d’urbanisme applicables…                          | —                                                       | `zone_PLU`, `servitudes`                               | Appel GPU/opendata + extraction LLM | S5_CONTEXT_SUMMARY        |
| S5_CONTEXT_SUMMARY | S4_CONTEXT_FETCH   | Données contexte dispo | Votre terrain est en zone X… [listes servitudes].                                        | Bouton Continuer                                        | `zone_confirmed=true`                                  | —                                   | S6_PROJECT_DETAILS        |

### Bloc 2 – Détails projet & faisabilité

|Step ID|Parent|Condition d’entrée|Message bot|Input attendu|Données capturées|Action système|Step suivant|
|---|---|---|---|---|---|---|---|
|S6_PROJECT_DETAILS|S5_CONTEXT_SUMMARY|Toujours|Pour affiner l’analyse, j’ai besoin de quelques détails : distance aux limites, à la rue, étage ou non, etc.|Réponses à plusieurs questions séquentielles (boutons + chiffres)|`dist_limite`, `dist_voie`, `nb_niveaux`, `accroche_batiment`, `type_toiture`, etc.|Construction d’un objet `projet_structuré`|S7_FEASIBILITY_COMPUTE|
|S7_FEASIBILITY_COMPUTE|S6_PROJECT_DETAILS|Projet structuré + règles dispo|(Message technique, non visible)|—|`etat_faisabilite` = compatible / risque / incompatible + `motifs`|Appel LLM de raisonnement|S8_FEASIBILITY_RESULT|
|S8_FEASIBILITY_RESULT|S7_FEASIBILITY_COMPUTE|Toujours|Texte en fonction de `etat_faisabilite` (compatible / à risque / incompatible) + explication courte|Boutons : Continuer / Voir variantes / Arrêter|—|—|Si compatible → S10_PROCEDURE_TYPE ; si risque ou incompatible → S9_VARIANTS_PROPOSE|
### Bloc 3 – Type de dossier & pièces

| Step ID                 | Parent                                      | Condition d’entrée                            | Message bot                                                                                                                                       | Input attendu                | Données capturées                                | Action système                                            | Step suivant                                             |
| ----------------------- | ------------------------------------------- | --------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------- | ------------------------------------------------ | --------------------------------------------------------- | -------------------------------------------------------- |
| S10_PROCEDURE_TYPE      | S8_FEASIBILITY_RESULT / S9_VARIANTS_PROPOSE | Projet jugé acceptable (compatible ou ajusté) | Pour ce type de projet, il faut en principe une [DP / PC / PA].                                                                                   | Bouton OK / “En savoir plus” | `type_dossier`                                   | Détermination type procédure (règles + seuils de surface) | S11_DOC_LIST                                             |
| S11_DOC_LIST            | S10_PROCEDURE_TYPE                          | Toujours                                      | Voici les pièces habituellement demandées : [liste générique adaptée au type dossier + type projet]. Souhaitez-vous une checklist personnalisée ? | Oui / Non                    | —                                                | —                                                         | Oui → S12_CHECKLIST_QUESTIONS ; Non → S18_EXPORT_SUMMARY |
| S12_CHECKLIST_QUESTIONS | S11_DOC_LIST                                | User veut personnaliser                       | Questionner sur quelques points : mitoyenneté, accès direct à rue, photos disponibles, etc.                                                       | Réponses aux questions       | `contexte_parcelle` (mitoyen, vue directe, etc.) | Adapter les pièces                                        | S13_CHECKLIST_RESULT                                     |
| S13_CHECKLIST_RESULT    | S12_CHECKLIST_QUESTIONS                     | Toujours                                      | Voici votre checklist personnalisée : [liste]. Voulez-vous que je vous aide à **remplir le formulaire** ?                                         | Oui / Non                    | —                                                | —                                                         | Oui → S14_FORM_ASSIST ; Non → S18_EXPORT_SUMMARY         |

### Bloc 4 – Assistance formulaire & premium

| Step ID           | Parent               | Condition d’entrée        | Message bot                                                                                                             | Input attendu                               | Données capturées                         | Action système                       | Step suivant                                            |
| ----------------- | -------------------- | ------------------------- | ----------------------------------------------------------------------------------------------------------------------- | ------------------------------------------- | ----------------------------------------- | ------------------------------------ | ------------------------------------------------------- |
| S14_FORM_ASSIST   | S13_CHECKLIST_RESULT | User veut aide formulaire | Je vais vous poser les questions nécessaires pour pré-remplir le CERFA : identité, coordonnées, références cadastrales… | Données personnelles & projet               | `identite_demandeur`, `coordonnees`, etc. | Remplissage structurel du formulaire | S15_FORM_SUMMARY                                        |
| S15_FORM_SUMMARY  | S14_FORM_ASSIST      | Toujours                  | Récapitulatif des infos. Souhaitez-vous générer le dossier (formulaire + récap projet) ?                                | Oui / Non                                   | —                                         | Génération brouillon PDF / JSON      | Oui → S16_OFFER_PREMIUM ; Non → S18_EXPORT_SUMMARY      |
| S16_OFFER_PREMIUM | S15_FORM_SUMMARY     | Toujours                  | Proposer premium : dépôt + suivi. Expliquer le service et le prix.                                                      | Boutons : “Je suis intéressé” / “Non merci” | `interet_premium`                         | —                                    | Intéressé → S17_PREMIUM_LEAD ; Non → S18_EXPORT_SUMMARY |
| S17_PREMIUM_LEAD  | S16_OFFER_PREMIUM    | User intéressé            | Demander mail / téléphone pour prise de contact ou paiement.                                                            | Coordonnées, consentement                   | `contact_premium`                         | Envoi lead vers CRM / outil interne  | S18_EXPORT_SUMMARY                                      |

### Bloc 5 – Sortie / résumé

| Step ID            | Parent                             | Condition d’entrée | Message bot                                                                                                                                  | Input attendu           | Données capturées             | Action système                             | Step suivant |
| ------------------ | ---------------------------------- | ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------- | ----------------------------- | ------------------------------------------ | ------------ |
| S18_EXPORT_SUMMARY | Multiples (S9, S11, S13, S15, S17) | Fin de parcours    | Je peux vous fournir un résumé de l’analyse et de vos prochaines étapes. Voulez-vous le télécharger au format PDF ou le recevoir par email ? | Choix + email si besoin | `mode_export`, `email_export` | Génération/sauvegarde du résumé de session | FIN          |